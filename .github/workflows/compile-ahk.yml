name: Compile AutoHotkey Scripts

on:
  push:
    branches: [ master, main ]
  pull_request:
    branches: [ master, main ]
  workflow_dispatch:  # Allow manual trigger

jobs:
  compile:
    runs-on: windows-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Get AutoHotkey version info for cache key
      id: get-versions
      shell: pwsh
      run: .\.github\scripts\get-ahk-versions.ps1
    
    - name: Cache AutoHotkey binaries
      uses: actions/cache@v4
      id: cache-ahk
      with:
        path: ${{ runner.temp }}/AutoHotkey
        key: ${{ steps.get-versions.outputs.cache-key }}
        restore-keys: |
          ahk-binaries-
    
    - name: Setup AutoHotkey Compiler
      shell: pwsh
      run: .\.github\scripts\install-ahk.ps1
    
    - name: Create output directories
      shell: pwsh
      run: |
        # Create base output directory structure
        $dirs = @("compiled/x86", "compiled/x64")
        foreach ($dir in $dirs) { New-Item -ItemType Directory -Force -Path $dir | Out-Null; echo "Created directory: $dir" }
    
    - name: Generate build timestamp
      shell: pwsh
      run: |
        $timestamp = Get-Date -Format "yyyyMMddHHmmss"
        echo "BUILD_TIMESTAMP=$timestamp" >> $env:GITHUB_ENV
        echo "Generated timestamp: $timestamp"
    
    - name: Install PowerShell-Yaml module
      shell: pwsh
      run: |
        echo "Installing PowerShell-Yaml module..."
        Install-Module -Name powershell-yaml -Force -Scope CurrentUser
    
    - name: Parse YAML configuration and compile
      shell: pwsh
      continue-on-error: true
      run: .\.github\scripts\compile-scripts.ps1
    
    - name: List compiled files
      shell: pwsh
      if: always()
      run: .\.github\scripts\list-compiled-files.ps1
    
    - name: Upload x86 executables
      uses: actions/upload-artifact@v4
      if: always() && hashFiles('compiled/x86/**/*.exe') != ''
      with:
        name: ahkexe-x86-${{ github.run_number }}-${{ env.BUILD_TIMESTAMP }}
        path: compiled/x86/
        retention-days: 30
    
    - name: Upload x64 executables
      uses: actions/upload-artifact@v4
      if: always() && hashFiles('compiled/x64/**/*.exe') != ''
      with:
        name: ahkexe-x64-${{ github.run_number }}-${{ env.BUILD_TIMESTAMP }}
        path: compiled/x64/
        retention-days: 30
    
    - name: Create release (on tags)
      if: startsWith(github.ref, 'refs/tags/') && hashFiles('compiled/**/*.exe') != ''
      uses: softprops/action-gh-release@v1
      with:
        files: compiled/**/*.exe
        draft: false
        prerelease: false
        body: |
          ## AutoHotkey Compiled Executables
          
          This release contains compiled executables for AutoHotkey scripts in both v1 and v2 formats, with 32-bit and 64-bit versions.
          
          ### Directory Structure:
          - `x86/` - 32-bit executables (both v1 and v2)
          - `x64/` - 64-bit executables (both v1 and v2)
          
          ### File Naming:
          - Files ending with `-v1-x86.exe` are AutoHotkey v1.1 32-bit versions
          - Files ending with `-v1-x64.exe` are AutoHotkey v1.1 64-bit versions
          - Files ending with `-v2-x86.exe` are AutoHotkey v2.0 32-bit versions
          - Files ending with `-v2-x64.exe` are AutoHotkey v2.0 64-bit versions
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}